jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Cordova
        run: |
          npm config set fetch-retries 5
          npm install -g cordova --no-audit --no-fund

      - name: Prepare and Build
        run: |
          # قبول تراخيص الأندرويد (ضروري جداً)
          yes | sdkmanager --licenses || true
          
          # إنشاء المشروع إذا لم يكن موجوداً
          if [ ! -f config.xml ]; then
            cordova create . safety.call.japan "Safety Call Japan"
          fi
          
          # إضافة المنصة والإضافات
          cordova platform add android@12.0.0 --save
          cordova plugin add cordova-plugin-android-permissions --save
          cordova plugin add cordova-plugin-device --save

          # إنشاء ملف التوقيع (لأغراض التجربة فقط هنا)
          keytool -genkey -v -keystore release.jks -alias safety_key -keyalg RSA -keysize 2048 -validity 10000 -storepass 123456 -keypass 123456 -dname "CN=Zakaria, O=SafetyCallJapan" -deststoretype pkcs12

          # إنشاء ملف build.json بشكل صحيح
          cat <<EOF > build.json
          {
              "android": {
                  "release": {
                      "keystore": "release.jks",
                      "storePassword": "123456",
                      "alias": "safety_key",
                      "password" : "123456",
                      "keystoreType": ""
                  }
              }
          }
          EOF

          # بناء التطبيق
          cordova build android --release --buildConfig=build.json -- --packageType=apk

      - name: Organize Output
        run: |
          mkdir -p output
          # البحث عن الـ APK في المسارات المحتملة ونسخه
          find platforms/android/app/build/outputs/apk/release/ -name "*.apk" -exec cp {} output/Safety_Call_Japan.apk \;

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: Safety-Call-Japan-APK
          path: output/
